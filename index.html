<script src="wave.js"></script>
<style>
.control {
  position: absolute;
  width: 0;
  height: 0;
}
.control span {
  position: absolute;
  left: -10px;
  top: -10px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  box-shadow: 0 0 2px black;
  background: white;
  opacity: 0.5;
  text-align: center;
  font-size: 16px;
  line-height: 20px;
  z-index: 3
}
.editor{
  width: 1200px;
  height: 1200px;
  position: relative;
  border: 2px solid gray;
  background: repeating-linear-gradient(90deg, #ddf 0, #ddf 1px, transparent 1px, transparent 39px, #ddf 39px, #ddf 40px),
  repeating-linear-gradient(0deg, #ddf 0, #ddf 1px, transparent 1px, transparent 19px, #ddf 19px, #ddf 20px)
}
.note.focus {
  background: #444;
}
.note-range.focus {
  background: rgba(0, 0, 255, 0.2)
}
.note {
  position: absolute;
  border-radius: 2px;
  background: gray;
  z-index: 2;
  box-shadow: 0 0 2px black inset;
  overflow: hidden;
}
.note .peek {
  position: absolute;
  width: 0px;
  height: 100%;
}
.note .peek:before {
  position: absolute;
  content: '';
  background: black;
  width: 2px;
  left: -1px;
  top: 0;
  height: 100%;
  box-shadow: 0 0 4px black;
}
.note .volume {
  position: absolute;
  right: 1px;
  bottom: 1px;
  font-size: 8px;
  color: silver;
}
.note-range {
  position: absolute;
  border-radius: 2px;
  background: rgba(255, 0, 0, 0.2);
}
</style>
<script>
const XSIZE = 40
const YSIZE = 20
const MAX_PITCH = 69 + 36
const MIN_PITCH = 69 - 36
let notes = []
let focusNote = null
let hashdata
function applyHash() {
  try {
    const data = location.hash.substr(1).split('/').map(s => s.split('_').map(v => Number(v)))
    data.forEach((args) => {
      if (args.length === 6) {
        const note = new Note(...args)
        notes.push(note)
      }
    })
  } catch(e) {}
}

function updateHash() {
  const data = notes.map(note => [
    note.start,
    note.length,
    note.pitch,
    note.band,
    note.peek,
    note.volume
  ].join('_')).join('/')
  location.hash = data
}
function createAudioSrc(parameters) {
  const waveData = createWaveFromParameters(
    parameters.map(({ start, length, pitch, band, peek, volume }) => ({
      w: band / 24 || 0.001,
      hz: 441 * Math.pow(2, (pitch - 69) / 12),
      fadein: length * 441 * peek,
      fadeout: length * 441,
      delay: start * 441,
      volume
    }))
  )
  return waveToDataURL(waveData)
}

class Note {
  constructor(start, length, pitch, band = 1, peek = 0.5, volume = 0.5) {
    this.start = start
    this.length = length
    this.pitch = pitch
    this.band = band
    this.peek = peek
    this.volume = volume
    this.dom = document.createElement('div')
    this.dom.className = 'note'
    this.rangeDom = document.createElement('div')
    this.rangeDom.className = 'note-range'
    this.peekDom = document.createElement('div')
    this.peekDom.className = 'peek'
    this.dom.appendChild(this.peekDom)
    this.volumeDom = document.createElement('div')
    this.volumeDom.className = 'volume'
    this.dom.appendChild(this.volumeDom)
    this.prepareControlPoints()
    this.audio = new Audio()
    this.audio.volume = 0.2
  }
  addVolume(v) {
    this.volume = Math.min(1, Math.max(0, Math.round(100 * (this.volume + v)) / 100))
    this.updatePosition()
  }
  startPlay() {
    const play = () => {
      this.audio.src = createAudioSrc([{ start: 0, length: this.length, pitch: this.pitch, band: this.band, peek: this.peek, volume: this.volume }])
      this.audio.play()
    }
    play()
    if (this.playTimer) clearInterval(this.playTimer)
    this.playTimer = setInterval(() => {
      play()
    }, this.length * 100 + 200)
  }
  stopPlay() {
    if (this.playTimer) clearInterval(this.playTimer)
    this.playTimer = null
  }
  prepareControlPoints() {
    const icon = iconText => {
      const el = document.createElement('div')
      el.className = 'control'
      el.innerHTML = `<span>${iconText}</span>`
      return el
    }
    const start = icon('←')
    const up = icon('↑')
    const down = icon('↓')
    const end = icon('→')
    const peek = icon('・')
    this.controlPoints = { up, down, start, end, peek }
    start.moved = (state, x, y) => {
      const diff = Math.min(state.start + state.length - 1, Math.max(0, state.start + Math.round(x / XSIZE))) - this.start
      this.start += diff
      this.length -= diff
      this.updatePosition()
    }
    up.moved = (state, x, y) => {
      this.band = Math.min(12, Math.max(0, state.band - Math.round(y / YSIZE)))
      this.updatePosition()
    }
    down.moved = (state, x, y) => {
      this.band = Math.min(12, Math.max(0, state.band + Math.round(y / YSIZE)))
      this.updatePosition()
    }
    end.moved = (state, x, y) => {
      this.length = Math.max(1, state.length + Math.round(x / XSIZE))
      this.updatePosition()
    }
    peek.moved = (state, x, y) => {
      this.peek = Math.min(1, Math.max(0, Math.round(1000 * (state.peek + x / XSIZE / this.length)) / 1000))
      this.updatePosition()
    }
    this.dom.moved = (state, x, y) => {
      this.start = Math.max(0, state.start + Math.round(x / XSIZE))
      this.pitch = Math.min(MAX_PITCH, state.pitch - Math.round(y / YSIZE))
      this.updatePosition()
    }
    ;[up, down, start, end, peek, this.dom].forEach(el => {
      el.onmousedown = e => {
        this.startPlay()
        e.preventDefault()
        if (focusNote) focusNote.hideControls()
        focusNote = this
        this.showControls()
        const x = e.pageX
        const y = e.pageY
        const state = {
          start: this.start, length: this.length,
          pitch: this.pitch, band: this.band,
          peek: this.peek
        }
        const mousemove = e => el.moved(state, e.pageX - x, e.pageY - y)
        const mouseup = () => {
          this.stopPlay()
          document.removeEventListener('mousemove', mousemove)
          document.removeEventListener('mouseup', mouseup)
        }
        document.addEventListener('mousemove', mousemove)
        document.addEventListener('mouseup', mouseup)
      }
    })
  }
  updatePosition() {
    updateHash()
    const offset = 10
    this.rangeDom.style.left = this.dom.style.left = this.start * XSIZE
    this.dom.style.top = (MAX_PITCH - this.pitch) * YSIZE
    this.rangeDom.style.width = this.dom.style.width = this.length * XSIZE
    this.dom.style.height = YSIZE
    this.rangeDom.style.top = (MAX_PITCH - this.pitch - this.band) * YSIZE
    this.rangeDom.style.height = (1 + 2 * this.band) * YSIZE
    const { up, down, start, end, peek } = this.controlPoints
    up.style.left = down.style.left = (this.start + this.length / 2) * XSIZE
    up.style.top = (MAX_PITCH - this.pitch - this.band) * YSIZE - offset
    down.style.top = (MAX_PITCH - this.pitch + this.band + 1) * YSIZE + offset
    end.style.left = (this.start + this.length) * XSIZE + offset
    start.style.left = this.start * XSIZE - offset
    peek.style.left = (this.start + this.peek * this.length) * XSIZE
    start.style.top = end.style.top = peek.style.top = (MAX_PITCH - this.pitch + 0.5) * YSIZE
    this.peekDom.style.left = `${this.peek * 100}%`
    this.volumeDom.textContent = Math.round(this.volume * 100) + '%'
    this.rangeDom.style.opacity = this.dom.style.opacity = 0.5 + 0.5 * this.volume
  }
  hideControls() {
    this.rangeDom.classList.remove('focus')
    this.dom.classList.remove('focus')
    this.volumeDom.style.display = 'none'
    for (const el of Object.values(this.controlPoints)) el.style.display = 'none'
  }
  showControls() {
    this.rangeDom.classList.add('focus')
    this.dom.classList.add('focus')
    this.volumeDom.style.display = ''
    for (const el of Object.values(this.controlPoints)) el.style.display = ''
  }
  appendTo(dom) {
    dom.appendChild(this.rangeDom)
    dom.appendChild(this.dom)
    for (const el of Object.values(this.controlPoints)) dom.appendChild(el)
  }
  remove() {
    this.dom.remove()
    this.rangeDom.remove()
    for (const el of Object.values(this.controlPoints)) el.remove()
  }
}
</script>
<body>
<button onclick="playAll()">play</button>
<div class="editor"></div>
<script>
  const editorElement = document.querySelector('.editor')
  const audio = new Audio()
  applyHash()
  notes.forEach(note => {
    note.appendTo(editorElement)
    note.hideControls()
    note.updatePosition()
  })
  audio.volume = 0.4
  function playAll() {
    audio.src = createAudioSrc(notes)
    audio.play()
  }
  editorElement.onmousedown = e => {
    if (e.target !== editorElement) return
    if (focusNote) {
      focusNote.hideControls()
      focusNote = null
    } else {
      const note = new Note(Math.floor(e.offsetX / XSIZE), 2, MAX_PITCH - Math.floor(e.offsetY / YSIZE), 1)
      note.appendTo(editorElement)
      note.updatePosition()
      notes.push(note)
      focusNote = note
      note.showControls()
      updateHash()
    }
  }
  let lastPlusMinus = null
  document.body.onkeydown = e => {
    if (e.key === 'Backspace') {
      focusNote.remove()
      notes = notes.filter(n => n != focusNote)
      focusNote = null
      updateHash()
    }
    if (lastPlusMinus && (lastPlusMinus.note !== focusNote || lastPlusMinus.time < new Date() - 100)) lastPlusMinus = null
    if (e.key === '+') {
      if (lastPlusMinus) {
        lastPlusMinus.value = Math.max(lastPlusMinus.value * 1.2, 0.01)
      } else {
        lastPlusMinus = { value: 0.01, note: focusNote }
      }
      lastPlusMinus.time = new Date()
      focusNote.addVolume(lastPlusMinus.value)
    } else if (e.key === '-')  {
      if (lastPlusMinus) {
        lastPlusMinus.value = Math.min(lastPlusMinus.value * 1.2, -0.01)
      } else {
        lastPlusMinus = { value: -0.01, note: focusNote }
      }
      focusNote.addVolume(lastPlusMinus.value)
      lastPlusMinus.time = new Date()
    } else {
      lastPlusMinus = null
    }
  }
  document.body.onkeyup = e => {
    lastPlusMinus = null
  }
</script>